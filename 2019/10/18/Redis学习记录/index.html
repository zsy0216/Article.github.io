<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16.ico?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="redis,">










<meta name="description" content="Redis # 一、从NoSQL说起  NoSQL是Not only SQL的缩写，大意为“不只是SQL”，说明这项技术是传统关系型数据库的补充而非替代。在整个NoSQL技术栈中MemCache、Redis、MongoDB被称为NoSQL三剑客。那么时代为什么需要NoSQL数据库呢？我们来做个对比：    对比 关系型数据库 NoSQL数据库    数据存储位置 硬盘 内存   数据结构 高度组织">
<meta name="keywords" content="redis">
<meta property="og:type" content="article">
<meta property="og:title" content="Redis学习记录">
<meta property="og:url" content="https://www.zsy.xyz/2019/10/18/Redis学习记录/index.html">
<meta property="og:site_name" content="Tassel&#39;s Blog">
<meta property="og:description" content="Redis # 一、从NoSQL说起  NoSQL是Not only SQL的缩写，大意为“不只是SQL”，说明这项技术是传统关系型数据库的补充而非替代。在整个NoSQL技术栈中MemCache、Redis、MongoDB被称为NoSQL三剑客。那么时代为什么需要NoSQL数据库呢？我们来做个对比：    对比 关系型数据库 NoSQL数据库    数据存储位置 硬盘 内存   数据结构 高度组织">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://zsy0216.github.io/image/%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84/redis/p01.png">
<meta property="og:image" content="https://zsy0216.github.io/image/%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84/redis/p02.png">
<meta property="og:image" content="https://zsy0216.github.io/image/%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84/redis/p03.png">
<meta property="og:image" content="https://zsy0216.github.io/image/%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84/redis/p04.png">
<meta property="og:updated_time" content="2019-10-18T09:26:47.072Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Redis学习记录">
<meta name="twitter:description" content="Redis # 一、从NoSQL说起  NoSQL是Not only SQL的缩写，大意为“不只是SQL”，说明这项技术是传统关系型数据库的补充而非替代。在整个NoSQL技术栈中MemCache、Redis、MongoDB被称为NoSQL三剑客。那么时代为什么需要NoSQL数据库呢？我们来做个对比：    对比 关系型数据库 NoSQL数据库    数据存储位置 硬盘 内存   数据结构 高度组织">
<meta name="twitter:image" content="https://zsy0216.github.io/image/%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84/redis/p01.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":true},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://www.zsy.xyz/2019/10/18/Redis学习记录/">





  <title>Redis学习记录 | Tassel's Blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Tassel's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description"></h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://www.zsy.xyz/2019/10/18/Redis学习记录/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Tassel">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/head.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Tassel's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">Redis学习记录</h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-10-18T17:24:48+08:00">
                2019-10-18
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/分布式架构/" itemprop="url" rel="index">
                    <span itemprop="name">分布式架构</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/10/18/Redis学习记录/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2019/10/18/Redis学习记录/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2019/10/18/Redis学习记录/" class="leancloud_visitors" data-flag-title="Redis学习记录">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  7.2k
                </span>
              

              

              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p style="text-align:center;font-size:100px;">Redis</p>
# 一、从NoSQL说起

<p>NoSQL是Not only SQL的缩写，大意为“不只是SQL”，说明这项技术是<b><font color="red">传统关系型数据库的补充</font></b>而非替代。在整个NoSQL技术栈中<b><font color="blue">MemCache</font></b>、<b><font color="blue">Redis</font></b>、<b><font color="blue">MongoDB</font></b>被称为NoSQL三剑客。那么时代为什么需要NoSQL数据库呢？我们来做个对比：</p>
<table>
<thead>
<tr>
<th>对比</th>
<th align="center">关系型数据库</th>
<th align="center">NoSQL数据库</th>
</tr>
</thead>
<tbody><tr>
<td>数据存储位置</td>
<td align="center">硬盘</td>
<td align="center">内存</td>
</tr>
<tr>
<td>数据结构</td>
<td align="center">高度组织化结构化数据</td>
<td align="center">没有预定义的模式</td>
</tr>
<tr>
<td>数据操作方式</td>
<td align="center">SQL</td>
<td align="center">所有数据都是键值对，没有声明性查询语言</td>
</tr>
<tr>
<td>事务控制</td>
<td align="center">严格的基础事务ACID原则</td>
<td align="center">CAP定理</td>
</tr>
</tbody></table>
<p>所以NoSQL数据库的最大优势体现为：高性能、高可用性和可伸缩性。</p>
<h1 id="二、Redis简介"><a href="#二、Redis简介" class="headerlink" title="二、Redis简介"></a>二、Redis简介</h1><p>Redis英文官网介绍：</p>
<blockquote>
<p>Redis is an open source (BSD licensed), in-memory data structure store, used as a database, cache and message broker. It supports data structures such as strings, hashes, lists, sets, sorted sets with range queries, bitmaps, hyperloglogs and geospatial indexes with radius queries. Redis has built-in replication, Lua scripting, LRU eviction, transactions and different levels of on-disk persistence, and provides high availability via Redis Sentinel and automatic partitioning with Redis Cluster.</p>
</blockquote>
<p>Redis中文官网介绍：</p>
<blockquote>
<p>Redis 是一个开源（BSD许可）的，内存中的数据结构存储系统，它可以用作数据库、缓存和消息中间件。 它支持多种类型的数据结构，如 字符串（strings）， 散列（hashes）， 列表（lists）， 集合（sets）， 有序集合（sorted sets） 与范围查询， bitmaps， hyperloglogs 和 地理空间（geospatial） 索引半径查询。 Redis 内置了 复制（replication），LUA脚本（Lua scripting）， LRU驱动事件（LRU eviction），事务（transactions） 和不同级别的 磁盘持久化（persistence）， 并通过 Redis哨兵（Sentinel）和自动 分区（Cluster）提供高可用性（high availability）。</p>
</blockquote>
<p>Redis命令参考文档网址：<a href="http://redisdoc.com" target="_blank" rel="noopener">http://redisdoc.com</a></p>
<h1 id="三、Redis安装"><a href="#三、Redis安装" class="headerlink" title="三、Redis安装"></a>三、Redis安装</h1><h2 id="1-下载并解压安装"><a href="#1-下载并解压安装" class="headerlink" title="1. 下载并解压安装"></a>1. 下载并解压安装</h2><ol>
<li><p>下载<code>redis-4.0.2.tar.gz</code>到<code>/opt</code>目录下</p>
</li>
<li><p>解压到当前目录下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf redis-4.0.2.tar.gz</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="2-安装C语言编译环境"><a href="#2-安装C语言编译环境" class="headerlink" title="2. 安装C语言编译环境"></a>2. 安装C语言编译环境</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum intall -y gcc-c++</span><br></pre></td></tr></table></figure>

<h2 id="3-修改安装位置"><a href="#3-修改安装位置" class="headerlink" title="3. 修改安装位置"></a>3. 修改安装位置</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim opt/src/Makefile</span><br><span class="line"><span class="meta">#</span><span class="bash">修改第27行</span></span><br><span class="line">PREFIX?=/user/local/redis</span><br></pre></td></tr></table></figure>

<h2 id="4-编译安装"><a href="#4-编译安装" class="headerlink" title="4. 编译安装"></a>4. 编译安装</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make #编译</span><br><span class="line">make install #安装 建议先拍快照</span><br></pre></td></tr></table></figure>

<h2 id="5-启动Redis服务器"><a href="#5-启动Redis服务器" class="headerlink" title="5.启动Redis服务器"></a>5.启动Redis服务器</h2><h3 id="①默认启动"><a href="#①默认启动" class="headerlink" title="①默认启动"></a>①默认启动</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# /usr/local/redis/bin/redis-server</span><br><span class="line">7239:C 07 Oct 18:59:12.144 # oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span><br><span class="line">7239:C 07 Oct 18:59:12.144 # Redis version=4.0.2, bits=64, commit=00000000, modified=0, pid=7239, just started</span><br><span class="line">7239:C 07 Oct 18:59:12.144 # Warning: no config file specified, using the default config. In order to specify a config file use /usr/local/redis/bin/redis-server /path/to/redis.conf</span><br><span class="line">7239:M 07 Oct 18:59:12.145 * Increased maximum number of open files to 10032 (it was originally set to 1024).</span><br><span class="line">                _._                                                  </span><br><span class="line">           _.-``__ ''-._                                             </span><br><span class="line">      _.-``    `.  `_.  ''-._           Redis 4.0.2 (00000000/0) 64 bit</span><br><span class="line">  .-`` .-```.  ```\/    _.,_ ''-._                                   </span><br><span class="line"> (    '      ,       .-`  | `,    )     Running in standalone mode</span><br><span class="line"> |`-._`-...-` __...-.``-._|'` _.-'|     Port: 6379</span><br><span class="line"> |    `-._   `._    /     _.-'    |     PID: 7239</span><br><span class="line">  `-._    `-._  `-./  _.-'    _.-'                                   </span><br><span class="line"> |`-._`-._    `-.__.-'    _.-'_.-'|                                  </span><br><span class="line"> |    `-._`-._        _.-'_.-'    |           http://redis.io        </span><br><span class="line">  `-._    `-._`-.__.-'_.-'    _.-'                                   </span><br><span class="line"> |`-._`-._    `-.__.-'    _.-'_.-'|                                  </span><br><span class="line"> |    `-._`-._        _.-'_.-'    |                                  </span><br><span class="line">  `-._    `-._`-.__.-'_.-'    _.-'                                   </span><br><span class="line">      `-._    `-.__.-'    _.-'                                       </span><br><span class="line">          `-._        _.-'                                           </span><br><span class="line">              `-.__.-'                                               </span><br><span class="line"></span><br><span class="line">7239:M 07 Oct 18:59:12.148 # WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.</span><br><span class="line">7239:M 07 Oct 18:59:12.148 # Server initialized</span><br><span class="line">7239:M 07 Oct 18:59:12.148 # WARNING overcommit_memory is set to 0! Background save may fail under low memory condition. To fix this issue add 'vm.overcommit_memory = 1' to /etc/sysctl.conf and then reboot or run the command 'sysctl vm.overcommit_memory=1' for this to take effect.</span><br><span class="line">7239:M 07 Oct 18:59:12.148 # WARNING you have Transparent Huge Pages (THP) support enabled in your kernel. This will create latency and memory usage issues with Redis. To fix this issue run the command 'echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled' as root, and add it to your /etc/rc.local in order to retain the setting after a reboot. Redis must be restarted after THP is disabled.</span><br><span class="line">7239:M 07 Oct 18:59:12.148 * Ready to accept connections</span><br></pre></td></tr></table></figure>

<p>停止Redis服务器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/redis/bin/redis-cli shutdown</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">7239:M 07 Oct 19:00:53.208 # User requested shutdown...</span><br><span class="line">7239:M 07 Oct 19:00:53.208 * Saving the final RDB snapshot before exiting.</span><br><span class="line">7239:M 07 Oct 19:00:53.214 * DB saved on disk</span><br><span class="line">7239:M 07 Oct 19:00:53.214 # Redis is now ready to exit, bye bye...</span><br></pre></td></tr></table></figure>

<h3 id="②定制配置项启动"><a href="#②定制配置项启动" class="headerlink" title="②定制配置项启动"></a>②定制配置项启动</h3><h4 id="1-准备配置文件"><a href="#1-准备配置文件" class="headerlink" title="[1]准备配置文件"></a>[1]准备配置文件</h4><p><code>cp /opt/redis-4.0.2/redis.conf /usr/local/redis/</code></p>
<h4 id="2-修改配置项"><a href="#2-修改配置项" class="headerlink" title="[2]修改配置项"></a>[2]修改配置项</h4><table>
<thead>
<tr>
<th>配置项名称</th>
<th>作用</th>
<th>取值</th>
</tr>
</thead>
<tbody><tr>
<td>daemonize</td>
<td>控制是否以守护进程形式运行Redis服务器</td>
<td>yes</td>
</tr>
<tr>
<td>logfile</td>
<td>指定日志文件位置</td>
<td>“/usr/local/redis/redis.log”</td>
</tr>
<tr>
<td>dir</td>
<td>Redis工作目录</td>
<td>/usr/local/redis</td>
</tr>
</tbody></table>
<p>注意：/var/logs目录需要我们提前创建好</p>
<h4 id="3-让Redis根据指定的配置文件启动"><a href="#3-让Redis根据指定的配置文件启动" class="headerlink" title="[3]让Redis根据指定的配置文件启动"></a>[3]让Redis根据指定的配置文件启动</h4><p>格式</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-server文件路径 redis.conf文件路径</span><br></pre></td></tr></table></figure>

<p>举例</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/redis/bin/redis-server /usr/local/redis/redis.conf</span><br></pre></td></tr></table></figure>

<h2 id="6-客户端登录"><a href="#6-客户端登录" class="headerlink" title="6.客户端登录"></a>6.客户端登录</h2><p><code>/usr/local/redis/bin/redis-cli -h 127.0.0.1 -p 6379</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; ping</span><br><span class="line">PONG</span><br><span class="line">127.0.0.1:6379&gt; exit</span><br></pre></td></tr></table></figure>

<p>关闭redis服务：/usr/local/bin/redis-cli -h IP地址 -p 端口号 shutdown</p>
<h1 id="四、Redis五种常用数据结构"><a href="#四、Redis五种常用数据结构" class="headerlink" title="四、Redis五种常用数据结构"></a>四、Redis五种常用数据结构</h1><h2 id="1-总体结构"><a href="#1-总体结构" class="headerlink" title="1.总体结构"></a>1.总体结构</h2><table>
    <tr>
        <th rowspan="1">KEY</th>
        <th>VALUE</th>
    
    </tr><tr><td rowspan="5">string</td>
        <td>string</td>
    </tr>
    <tr>
        <td>list</td>
    </tr>
    <tr>
        <td>set</td>
    </tr>
    <tr>
        <td>hash</td>
    </tr>
    <tr>
        <td>zset</td>
    </tr>
</table>

<p>Redis中的数据，总体上是键值对，不同数据类型指的是键值对中值的类型。</p>
<h2 id="2-string类型"><a href="#2-string类型" class="headerlink" title="2.string类型"></a>2.string类型</h2><p>Redis中最基本的类型，它是key对应的一个单一值。二进制安全，不必担心由于编码等问题导致二进制数据变化。所以redis的string可以包含任何数据，比如jpg图片或者序列化的对象。Redis中一个字符串值的最大容量是512M。</p>
<h2 id="3-list类型"><a href="#3-list类型" class="headerlink" title="3.list类型"></a>3.list类型</h2><p>Redis 列表是简单的字符串列表，按照插入顺序排序。你可以添加一个元素到列表的头部（左边）或者尾部（右边）。说明它的底层是基于链表实现的，所以它操作时头尾效率高，中间效率低。</p>
<p><img src="https://zsy0216.github.io/image/%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84/redis/p01.png" alt="p01"></p>
<h2 id="2-set类型"><a href="#2-set类型" class="headerlink" title="2.set类型"></a>2.set类型</h2><p>Redis的set是string类型的无序集合。它是基于哈希表实现的。</p>
<h2 id="3-hash类型"><a href="#3-hash类型" class="headerlink" title="3.hash类型"></a>3.hash类型</h2><p>本身就是一个键值对集合。可以当做Java中的Map&lt;String,Object&gt;对待。</p>
<h2 id="4-zset类型"><a href="#4-zset类型" class="headerlink" title="4.zset类型"></a>4.zset类型</h2><p>Redis zset 和 set 一样也是string类型元素的集合,且不允许重复的成员。不同的是每个元素都会关联一个double类型的分数。redis正是通过分数来为集合中的成员进行从小到大的排序。zset的成员是唯一的,但分数(score)却可以重复。</p>
<h1 id="五、Redis命令行操作"><a href="#五、Redis命令行操作" class="headerlink" title="五、Redis命令行操作"></a>五、Redis命令行操作</h1><h2 id="1-基本操作"><a href="#1-基本操作" class="headerlink" title="1.基本操作"></a>1.基本操作</h2><h3 id="①切换数据库"><a href="#①切换数据库" class="headerlink" title="①切换数据库"></a>①切换数据库</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Redis默认有16个数据库。</span><br><span class="line">115 # Set the number of databases. The default database is DB 0, you can select</span><br><span class="line">116 # a different one on a per-connection basis using SELECT &lt;dbid&gt; where</span><br><span class="line">117 # dbid is a number between 0 and 'databases'-1</span><br><span class="line">118 databases 16</span><br><span class="line">使用select进行切换，数据库索引从0开始</span><br><span class="line">127.0.0.1:6379&gt; select 2</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379[2]&gt; select 0</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure>

<h3 id="②查看数据库长度"><a href="#②查看数据库长度" class="headerlink" title="②查看数据库长度"></a>②查看数据库长度</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; dbsize</span><br><span class="line">(integer) 3</span><br></pre></td></tr></table></figure>

<h2 id="2-KEY操作"><a href="#2-KEY操作" class="headerlink" title="2.KEY操作"></a>2.KEY操作</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">●KEYS PATTERN</span><br><span class="line">●TYPE KEY</span><br><span class="line">	返回KEY对应的值的类型</span><br><span class="line">●MOVE KEY DB</span><br><span class="line">	把一组键值对数据移动到另一个数据库中</span><br><span class="line">●DEL KEY [KEY ...]</span><br><span class="line">	根据KEY进行删除，至少要指定一个KEY</span><br><span class="line">●EXISTS KEY</span><br><span class="line">	检查指定的KEY是否存在。指定一个KEY时，存在返回1，不存在返回0。可以指定多个，返回存在的KEY的数量。</span><br><span class="line">●RANDOMKEY</span><br><span class="line">	在现有的KEY中随机返回一个</span><br><span class="line">●RENAME KEY NEWKEY</span><br><span class="line">	重命名一个KEY，NEWKEY不管是否是已经存在的都会执行，如果NEWKEY已经存在则会被覆盖。</span><br><span class="line">●RENAMENX KEY NEWKEY</span><br><span class="line">	只有在NEWKEY不存在时能够执行成功，否则失败</span><br><span class="line">●TIME</span><br><span class="line">	返回当前UNIX时间戳</span><br><span class="line">●TTL KEY</span><br><span class="line">	以秒为单位查看KEY还能存在多长时间</span><br><span class="line">●PTTL KEY</span><br><span class="line">	以毫秒为单位查看KEY还能存在多长时间</span><br><span class="line">●EXPIRE KEY SECONDS</span><br><span class="line">	给一个KEY设置在SECONDS秒后过期，过期会被Redis移除。</span><br><span class="line">●EXPIREAT KEY TIMESTAMP</span><br><span class="line">	设置一个KEY在TIMESTAMP指定的时间过期</span><br><span class="line">●PEXPIRE KEY MILLISECONDS</span><br><span class="line">	以毫秒为单位指定过期时间</span><br><span class="line">●PEXPIREAT KEY MILLISECONDS-TIMESTAMP</span><br><span class="line">	以毫秒为单位指定过期的时间戳</span><br><span class="line">●PERSIST KEY</span><br><span class="line">	移除过期时间，变成永久key</span><br></pre></td></tr></table></figure>

<h2 id="2-string操作"><a href="#2-string操作" class="headerlink" title="2.string操作"></a>2.string操作</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">●SET KEY VALUE [EX SECONDS] [PX MILLISECONDS] [NX|XX]</span><br><span class="line">	给KEY设置一个string类型的值。</span><br><span class="line">	EX参数用于设置存活的秒数。</span><br><span class="line">	PX参数用于设置存活的毫秒数。</span><br><span class="line">	NX参数表示当前命令中指定的KEY不存在才行。</span><br><span class="line">	XX参数表示当前命令中指定的KEY存在才行。</span><br><span class="line">●GET KEY</span><br><span class="line">	根据key得到值，只能用于string类型。</span><br><span class="line">●APPEND KEY VALUE</span><br><span class="line">	把指定的value追加到KEY对应的原来的值后面，返回值是追加后字符串长度</span><br><span class="line">●STRLEN KEY</span><br><span class="line">	直接返回字符串长度</span><br><span class="line">●INCR KEY</span><br><span class="line">	自增1</span><br><span class="line">●DECR KEY</span><br><span class="line">	自减1</span><br><span class="line">●INCRBY KEY INCREMENT</span><br><span class="line">	原值+INCREMENT</span><br><span class="line">●DECRBY KEY DECREMENT</span><br><span class="line">	原值-DECREMENT</span><br><span class="line">●GETRANGE KEY START END</span><br><span class="line">	从字符串中取指定的一段</span><br><span class="line">●SETRANGE KEY OFFSET VALUE</span><br><span class="line">	从offset开始使用VALUE进行替换</span><br><span class="line">●SETEX KEY SECONDS VALUE</span><br><span class="line">	设置KEY,VALUE时指定存在秒数</span><br><span class="line">●SETNX KEY VALUE</span><br><span class="line">	新建字符串类型的键值对</span><br><span class="line">●MSET KEY VALUE [KEY VALUE ...]</span><br><span class="line">	一次性设置一组多个键值对</span><br><span class="line">●MGET KEY [KEY ...]</span><br><span class="line">	一次性指定多个KEY，返回它们对应的值，没有值的KEY返回值是(nil)</span><br><span class="line">●MSETNX KEY VALUE [KEY VALUE ...]</span><br><span class="line">	一次性新建多个值</span><br><span class="line">●GETSET KEY VALUE</span><br><span class="line">	设置新值，同时能够将旧值返回</span><br></pre></td></tr></table></figure>

<h2 id="3-list操作"><a href="#3-list操作" class="headerlink" title="3.list操作"></a>3.list操作</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">●LPUSH key value [value ...]</span><br><span class="line">●RPUSH key value [value ...]</span><br><span class="line">●LRANGE key start stop</span><br><span class="line">	根据list集合的索引打印元素数据</span><br><span class="line">	正着数：0,1,2,3,...</span><br><span class="line">	倒着数：-1,-2,-3,...</span><br><span class="line">●LLEN key</span><br><span class="line">●LPOP key</span><br><span class="line">	从左边弹出一个元素。</span><br><span class="line">	弹出=返回+删除。</span><br><span class="line">●RPOP key</span><br><span class="line">	从右边弹出一个元素。</span><br><span class="line">●RPOPLPUSH source destination</span><br><span class="line">	从source中RPOP一个元素，LPUSH到destination中</span><br><span class="line">●LINDEX key index</span><br><span class="line">	根据索引从集合中取值</span><br><span class="line">●LINSERT key BEFORE|AFTER pivot value</span><br><span class="line">	在pivot指定的值前面或后面插入value</span><br><span class="line">●LPUSHX key value</span><br><span class="line">	只能针对存在的list执行LPUSH</span><br><span class="line">●LREM key count value</span><br><span class="line">	根据count指定的数量从key对应的list中删除value</span><br><span class="line">●LSET key index value</span><br><span class="line">	把指定索引位置的元素替换为另一个值</span><br><span class="line">●LTRIM key start stop</span><br><span class="line">	仅保留指定区间的数据，两边的数据被删除</span><br></pre></td></tr></table></figure>

<h2 id="4-set操作"><a href="#4-set操作" class="headerlink" title="4.set操作"></a>4.set操作</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">●SADD key member [member ...]</span><br><span class="line">●SMEMBERS key</span><br><span class="line">●SCARD key</span><br><span class="line">	返回集合中元素的数量</span><br><span class="line">●SISMEMBER key member</span><br><span class="line">	检查当前指定member是否是集合中的元素</span><br><span class="line">●SREM key member [member ...]</span><br><span class="line">	从集合中删除元素</span><br><span class="line">●SINTER key [key ...]</span><br><span class="line">	将指定的集合进行“交集”操作</span><br><span class="line">	集合A：a,b,c</span><br><span class="line">	集合B：b,c,d</span><br><span class="line">	交集：b,c</span><br><span class="line">●SINTERSTORE destination key [key ...]</span><br><span class="line">	取交集后存入destination</span><br><span class="line">●SDIFF key [key ...]</span><br><span class="line">	将指定的集合执行“差集”操作</span><br><span class="line">	集合A：a,b,c</span><br><span class="line">	集合B：b,c,d</span><br><span class="line">	A对B执行diff：a</span><br><span class="line">	相当于：A-交集部分</span><br><span class="line">●SDIFFSTORE destination key [key ...]</span><br><span class="line">●SUNION key [key ...]</span><br><span class="line">	将指定的集合执行“并集”操作</span><br><span class="line">	集合A：a,b,c</span><br><span class="line">	集合B：b,c,d</span><br><span class="line">	并集：a,b,c,d</span><br><span class="line">●SUNIONSTORE destination key [key ...]</span><br><span class="line">●SMOVE source destination member</span><br><span class="line">	把member从source移动到destination</span><br><span class="line">●SPOP key [count]</span><br><span class="line">	从集合中随机弹出count个数量的元素，count不指定就弹出1个</span><br><span class="line">●SRANDMEMBER key [count]</span><br><span class="line">	从集合中随机返回count个数量的元素，count不指定就返回1个</span><br><span class="line">●SSCAN key cursor [MATCH pattern] [COUNT count]</span><br><span class="line">	基于游标的遍历</span><br></pre></td></tr></table></figure>

<h2 id="5-hash操作"><a href="#5-hash操作" class="headerlink" title="5.hash操作"></a>5.hash操作</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">●HSET key field value</span><br><span class="line">●HGETALL key</span><br><span class="line">●HGET key field</span><br><span class="line">●HLEN key</span><br><span class="line">●HKEYS key</span><br><span class="line">●HVALS key</span><br><span class="line">●HEXISTS key field</span><br><span class="line">●HDEL key field [field ...]</span><br><span class="line">●HINCRBY key field increment</span><br><span class="line">●HMGET key field [field ...]</span><br><span class="line">●HMSET key field value [field value ...]</span><br><span class="line">●HSETNX key field value</span><br><span class="line">●HSCAN key cursor [MATCH pattern] [COUNT count]</span><br></pre></td></tr></table></figure>

<h2 id="6-zset操作"><a href="#6-zset操作" class="headerlink" title="6.zset操作"></a>6.zset操作</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">●ZADD key [NX|XX] [CH] [INCR] score member [score member ...]</span><br><span class="line">●ZRANGE key start stop [WITHSCORES]</span><br><span class="line">●ZCARD key</span><br><span class="line">●ZCOUNT key min max</span><br><span class="line">	根据分数在min，max之间查找元素</span><br><span class="line">●ZSCORE key member</span><br><span class="line">●ZINCRBY key increment member</span><br><span class="line">●ZLEXCOUNT key min max</span><br><span class="line">●ZRANGEBYLEX key min max [LIMIT offset count]</span><br><span class="line">	按照字母顺序在区间内返回member</span><br><span class="line">	min和max使用“[a”表示闭区间，使用“(a”表示开区间</span><br><span class="line">	-表示负无穷</span><br><span class="line">	+表示正无穷</span><br><span class="line">●ZRANGEBYSCORE key min max [WITHSCORES] [LIMIT offset count]</span><br><span class="line">	在分数的指定区间内返回数据</span><br><span class="line">●ZRANK key member</span><br><span class="line">	先对分数进行升序排序，返回member的排名</span><br><span class="line">●ZREM key member [member ...]</span><br><span class="line">●ZREMRANGEBYLEX key min max</span><br><span class="line">●ZREMRANGEBYRANK key start stop</span><br><span class="line">●ZREMRANGEBYSCORE key min max</span><br><span class="line">●ZREVRANGE key start stop [WITHSCORES]</span><br><span class="line">●ZREVRANGEBYSCORE key max min [WITHSCORES] [LIMIT offset count]</span><br><span class="line">●ZREVRANK key member</span><br><span class="line">●ZINTERSTORE destination numkeys key [key ...] [WEIGHTS weight [weight ...]] [AGGREGATE SUM|MIN|MAX]</span><br><span class="line">●ZUNIONSTORE destination numkeys key [key ...] [WEIGHTS weight] [AGGREGATE SUM|MIN|MAX]</span><br><span class="line">	把指定集合的member取交集，分数会相加</span><br><span class="line">●ZSCAN key cursor [MATCH pattern] [COUNT count]</span><br></pre></td></tr></table></figure>

<h1 id="六、Redis持久化机制"><a href="#六、Redis持久化机制" class="headerlink" title="六、Redis持久化机制"></a>六、Redis持久化机制</h1><p><a href="https://redis.io/topics/persistence#snapshotting" target="_blank" rel="noopener">官网描述</a></p>
<p>Redis工作时数据都存储在内存中，万一服务器断电，则所有数据都会丢失。针对这种情况，Redis采用持久化机制来增强数据安全性。</p>
<h2 id="1-RDB"><a href="#1-RDB" class="headerlink" title="1.RDB"></a>1.RDB</h2><h3 id="①机制描述"><a href="#①机制描述" class="headerlink" title="①机制描述"></a>①机制描述</h3><p>每隔一定的时间把内存中的数据作为一个快照保存到硬盘上的文件中。Redis默认开启RDB机制。</p>
<h3 id="②触发时机"><a href="#②触发时机" class="headerlink" title="②触发时机"></a>②触发时机</h3><h4 id="1-基于默认配置"><a href="#1-基于默认配置" class="headerlink" title="[1]基于默认配置"></a>[1]基于默认配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">save 900 1</span><br><span class="line">save 300 10</span><br><span class="line">save 60 10000</span><br></pre></td></tr></table></figure>

<p>含义</p>
<table>
<thead>
<tr>
<th>配置</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>save 900 1</td>
<td>900秒内至少有一次修改则触发保存操作</td>
</tr>
<tr>
<td>save 300 10</td>
<td>300秒内至少有10次修改则触发保存操作</td>
</tr>
<tr>
<td>save 60 10000</td>
<td>60秒内至少有1万次修改则触发保存操作</td>
</tr>
</tbody></table>
<h4 id="2-使用保存命令"><a href="#2-使用保存命令" class="headerlink" title="[2]使用保存命令"></a>[2]使用保存命令</h4><p>save或bgsave</p>
<h4 id="3-使用flushall命令"><a href="#3-使用flushall命令" class="headerlink" title="[3]使用flushall命令"></a>[3]使用flushall命令</h4><p>这个命令也会产生dump.rdb文件，但里面是空的，没有意义，相当于删除所有数据。</p>
<h4 id="4-服务器关闭"><a href="#4-服务器关闭" class="headerlink" title="[4]服务器关闭"></a>[4]服务器关闭</h4><p>如果执行SHUTDOWN命令让Redis正常退出，那么此前Redis就会执行一次持久化保存。</p>
<h3 id="③相关配置"><a href="#③相关配置" class="headerlink" title="③相关配置"></a>③相关配置</h3><table>
<thead>
<tr>
<th>配置项</th>
<th>取值</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>save</td>
<td>“”</td>
<td>禁用RDB机制</td>
</tr>
<tr>
<td>dbfilename</td>
<td>文件名，例如：dump.rdb</td>
<td>设置RDB机制下，数据存储文件的文件名</td>
</tr>
<tr>
<td>dir</td>
<td>Redis工作目录路径</td>
<td>指定存放持久化文件的目录的路径。注意：这里指定的必须是目录不能是文件名</td>
</tr>
</tbody></table>
<h3 id="④思考"><a href="#④思考" class="headerlink" title="④思考"></a>④思考</h3><p>RDB机制能够保证数据的绝对安全吗？</p>
<h2 id="2-AOF"><a href="#2-AOF" class="headerlink" title="2.AOF"></a>2.AOF</h2><h3 id="①机制描述-1"><a href="#①机制描述-1" class="headerlink" title="①机制描述"></a>①机制描述</h3><p>根据配置文件中指定的策略，把生成数据的命令保存到硬盘上的文件中。一个AOF文件的内容可以参照下面的例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">*2</span><br><span class="line">$6</span><br><span class="line">SELECT</span><br><span class="line">$1</span><br><span class="line">0</span><br><span class="line">*3</span><br><span class="line">$3</span><br><span class="line">set</span><br><span class="line">$3</span><br><span class="line">num</span><br><span class="line">$2</span><br><span class="line">10</span><br><span class="line">*2</span><br><span class="line">$4</span><br><span class="line">incr</span><br><span class="line">$3</span><br><span class="line">num</span><br><span class="line">*2</span><br><span class="line">$4</span><br><span class="line">incr</span><br><span class="line">$3</span><br><span class="line">num</span><br><span class="line">*2</span><br><span class="line">$4</span><br><span class="line">incr</span><br><span class="line">$3</span><br><span class="line">num</span><br></pre></td></tr></table></figure>

<p>生成上面文件内容的Redis命令是：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">set num 10</span><br><span class="line">incr num</span><br><span class="line">incr num</span><br><span class="line">incr num</span><br></pre></td></tr></table></figure>

<h3 id="②AOF基本配置"><a href="#②AOF基本配置" class="headerlink" title="②AOF基本配置"></a>②AOF基本配置</h3><table>
<thead>
<tr>
<th>配置项</th>
<th>取值</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>appendonly</td>
<td>yes</td>
<td>启用AOF持久化机制</td>
</tr>
<tr>
<td></td>
<td>no</td>
<td>禁用AOF持久化机制[默认值]</td>
</tr>
<tr>
<td>appendfilename</td>
<td>“文件名”</td>
<td>AOF持久化文件名</td>
</tr>
<tr>
<td>dir</td>
<td>Redis工作目录路径</td>
<td>指定存放持久化文件的目录的路径。注意：这里指定的必须是目录不能是文件名</td>
</tr>
<tr>
<td>appendfsync</td>
<td>always</td>
<td>每一次数据修改后都将执行文件写入操作，缓慢但是最安全。</td>
</tr>
<tr>
<td></td>
<td>everysec</td>
<td>每秒执行一次写入操作。折中。</td>
</tr>
<tr>
<td></td>
<td>no</td>
<td>由操作系统在适当的时候执行写入操作，最快。</td>
</tr>
</tbody></table>
<h3 id="③AOF重写"><a href="#③AOF重写" class="headerlink" title="③AOF重写"></a>③AOF重写</h3><p>对比下面两组命令：</p>
<table>
<thead>
<tr>
<th>AOF重写前</th>
<th>AOF重写后</th>
</tr>
</thead>
<tbody><tr>
<td>set count 1<br>incr count<br>incr count<br>incr count</td>
<td>set count 4</td>
</tr>
</tbody></table>
<p>两组命令执行后对于count来说最终的值是一致的，但是进行AOF重写后省略了中间过程，可以让AOF文件体积更小。而Redis会根据AOF文件的体积来决定是否进行AOF重写。参考的配置项如下：</p>
<table>
<thead>
<tr>
<th>配置项</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>auto-aof-rewrite-percentage 100</td>
<td>文件体积增大100%时执行AOF重写</td>
</tr>
<tr>
<td>auto-aof-rewrite-min-size 64mb</td>
<td>文件体积增长到64mb时执行AOF重写</td>
</tr>
</tbody></table>
<p>实际工作中不要进行频繁的AOF重写，因为CPU资源和硬盘资源二者之间肯定是CPU资源更加宝贵，所以不应该过多耗费CPU性能去节省硬盘空间。</p>
<h2 id="3-持久化文件损坏修复"><a href="#3-持久化文件损坏修复" class="headerlink" title="3.持久化文件损坏修复"></a>3.持久化文件损坏修复</h2><p>Redis服务器启动时如果读取了损坏的持久化文件会导致启动失败，此时为了让Redis服务器能够正常启动，需要对损坏的持久化文件进行修复。这里以AOF文件为例介绍修复操作的步骤。</p>
<ul>
<li><p>第一步：备份要修复的appendonly.aof文件</p>
</li>
<li><p>第二步：执行修复程序</p>
<p>/usr/local/redis/bin/redis-check-aof –fix /usr/local/redis/appendonly.aof</p>
</li>
<li><p>第三步：重启Redis</p>
</li>
</ul>
<p>注意：所谓修复持久化文件仅仅是把损坏的部分去掉，而没法把受损的数据找回。</p>
<h2 id="4-扩展阅读：两种持久化机制的取舍"><a href="#4-扩展阅读：两种持久化机制的取舍" class="headerlink" title="4.扩展阅读：两种持久化机制的取舍"></a>4.扩展阅读：两种持久化机制的取舍</h2><h3 id="①RDB"><a href="#①RDB" class="headerlink" title="①RDB"></a>①RDB</h3><h4 id="1-优势"><a href="#1-优势" class="headerlink" title="[1]优势"></a>[1]优势</h4><p>适合大规模的数据恢复，速度较快</p>
<h4 id="2-劣势"><a href="#2-劣势" class="headerlink" title="[2]劣势"></a>[2]劣势</h4><p>会丢失最后一次快照后的所有修改，不能绝对保证数据的高度一致性和完整性。Fork的时候，内存中的数据被克隆了一份，大致2倍的膨胀性需要考虑，但上述成立有条件，Linux也有优化手段</p>
<h3 id="②AOF"><a href="#②AOF" class="headerlink" title="②AOF"></a>②AOF</h3><h4 id="1-优势-1"><a href="#1-优势-1" class="headerlink" title="[1]优势"></a>[1]优势</h4><p>选择appendfsync always方式运行时理论上能够做到数据完整一致，但此时性能又不好。文件内容具备一定可读性，能够用来分析Redis工作情况。</p>
<h4 id="2-劣势-1"><a href="#2-劣势-1" class="headerlink" title="[2]劣势"></a>[2]劣势</h4><p>持久化相同的数据，文件体积比RDB大，恢复速度比RDB慢。效率在同步写入时低于RDB，不同步写入时与RDB相同。</p>
<h3 id="③RDB和AOF并存"><a href="#③RDB和AOF并存" class="headerlink" title="③RDB和AOF并存"></a>③RDB和AOF并存</h3><p>Redis重启的时候会优先载入AOF文件来恢复原始的数据，因为在通常情况下AOF文件保存的数据集要比RDB文件保存的数据集要完整</p>
<p>RDB的数据不实时，同时使用两者时服务器重启也只会找AOF文件。那要不要只使用AOF呢？作者建议不要，因为RDB更适合用于备份数据库(AOF在不断变化不好备份)、快速重启，而且不会有AOF可能潜在的bug，留着作为一个万一的手段。</p>
<h3 id="④使用建议"><a href="#④使用建议" class="headerlink" title="④使用建议"></a>④使用建议</h3><p>如果Redis仅仅作为缓存可以不使用任何持久化方式。</p>
<p>其他应用方式综合考虑性能和完整性、一致性要求。</p>
<p>RDB文件只用作后备用途，建议只在Slave上持久化RDB文件，而且只要15分钟备份一次就够了，只保留save 900 1这条规则。如果Enalbe AOF，好处是在最恶劣情况下也只会丢失不超过两秒数据，启动脚本较简单只load自己的AOF文件就可以了。代价一是带来了持续的IO，二是AOF rewrite的最后将rewrite过程中产生的新数据写到新文件造成的阻塞几乎是不可避免的。只要硬盘许可，应该尽量减少AOF rewrite的频率，AOF重写的基础大小默认值64M太小了，可以设到5G以上。默认超过原大小100%大小时重写可以改到适当的数值。如果不开启AOF，仅靠Master-Slave Replication 实现高可用性能也不错。能省掉一大笔IO也减少了rewrite时带来的系统波动。代价是如果Master/Slave同时倒掉，会丢失十几分钟的数据，启动脚本也要比较两个Master/Slave中的RDB文件，载入较新的那个。新浪微博就选用了这种架构。</p>
<h1 id="七、Redis事务控制"><a href="#七、Redis事务控制" class="headerlink" title="七、Redis事务控制"></a>七、Redis事务控制</h1><h2 id="1-Redis事务控制的相关命令"><a href="#1-Redis事务控制的相关命令" class="headerlink" title="1.Redis事务控制的相关命令"></a>1.Redis事务控制的相关命令</h2><table>
<thead>
<tr>
<th>命令名</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>MULTI</td>
<td>表示开始收集命令，后面所有命令都不是马上执行，而是加入到一个队列中。</td>
</tr>
<tr>
<td>EXEC</td>
<td>执行MULTI后面命令队列中的所有命令。</td>
</tr>
<tr>
<td>DISCARD</td>
<td>放弃执行队列中的命令。</td>
</tr>
<tr>
<td>WATCH</td>
<td>“观察“、”监控“一个KEY，在当前队列外的其他命令操作这个KEY时，放弃执行自己队列的命令</td>
</tr>
<tr>
<td>UNWATCH</td>
<td>放弃监控一个KEY</td>
</tr>
</tbody></table>
<h2 id="2-命令队列执行失败的两种情况"><a href="#2-命令队列执行失败的两种情况" class="headerlink" title="2.命令队列执行失败的两种情况"></a>2.命令队列执行失败的两种情况</h2><h3 id="①加入队列时失败"><a href="#①加入队列时失败" class="headerlink" title="①加入队列时失败"></a>①加入队列时失败</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; multi</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set age 20</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; incr age</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; incr age www</span><br><span class="line">(error) ERR wrong number of arguments for 'incr' command</span><br><span class="line">127.0.0.1:6379&gt; exec</span><br><span class="line">(error) EXECABORT Transaction discarded because of previous errors.</span><br></pre></td></tr></table></figure>

<p>遇到了入队时即可检测到的错误，整个队列都不会执行。</p>
<h3 id="②执行队列时失败"><a href="#②执行队列时失败" class="headerlink" title="②执行队列时失败"></a>②执行队列时失败</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; multi</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set age 30</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; incrby age 5</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; incrby age 5</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; incrby age ww</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; incrby age 5</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; EXEC</span><br><span class="line">1) OK</span><br><span class="line">2) (integer) 35</span><br><span class="line">3) (integer) 40</span><br><span class="line">4) (error) ERR value is not an integer or out of range</span><br><span class="line">5) (integer) 45</span><br><span class="line">127.0.0.1:6379&gt; get age</span><br><span class="line">"45"</span><br></pre></td></tr></table></figure>

<p>错误在入队时检测不出来，整个队列执行时有错的命令执行失败，但是其他命令并没有回滚。</p>
<h3 id="③Redis为什么不支持回滚"><a href="#③Redis为什么不支持回滚" class="headerlink" title="③Redis为什么不支持回滚"></a>③Redis为什么不支持回滚</h3><p>官方解释如下：</p>
<blockquote>
<pre><code>如果你有使用关系式数据库的经验， 那么 “Redis 在事务失败时不进行回滚，而是继续执行余下的命令”这种做法可能会让你觉得有点奇怪。以下是这种做法的优点：
    1.Redis 命令只会因为错误的语法而失败（并且这些问题不能在入队时发现），或是命令用在了错误类型的键上面：这也就是说，从实用性的角度来说，失败的命令是由编程错误造成的，而这些错误应该在开发的过程中被发现，而不应该出现在生产环境中。
     2.因为不需要对回滚进行支持，所以 Redis 的内部可以保持简单且快速。
    有种观点认为 Redis 处理事务的做法会产生 bug ， 然而需要注意的是， 在通常情况下， 回滚并不能解决编程错误带来的问题。 举个例子， 如果你本来想通过 INCR 命令将键的值加上 1 ， 却不小心加上了 2 ， 又或者对错误类型的键执行了 INCR ， 回滚是没有办法处理这些情况的。</code></pre></blockquote>
<h2 id="3-悲观锁和乐观锁"><a href="#3-悲观锁和乐观锁" class="headerlink" title="3.悲观锁和乐观锁"></a>3.悲观锁和乐观锁</h2><p>在使用WATCH命令监控一个KEY后，当前队列中的命令会由于外部命令的执行而放弃，这是乐观锁的体现。</p>
<ul>
<li><p>悲观锁</p>
<p>认为当前环境非常容易发生碰撞，所以执行操作前需要把数据锁定，操作完成后释放锁，其他操作才可以继续操作。</p>
</li>
<li><p>乐观锁</p>
<p>认为当前环境不容易发生碰撞，所以执行操作前不锁定数据，万一碰撞真的发生了，那么放弃自己的操作。</p>
</li>
</ul>
<h1 id="八、Redis主从复制机制"><a href="#八、Redis主从复制机制" class="headerlink" title="八、Redis主从复制机制"></a>八、Redis主从复制机制</h1><p><img src="https://zsy0216.github.io/image/%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84/redis/p02.png" alt="p02"></p>
<h2 id="1-读写分离的好处："><a href="#1-读写分离的好处：" class="headerlink" title="1.读写分离的好处："></a>1.读写分离的好处：</h2><ul>
<li>性能优化：主服务器专注于写操作，可以用更适合写入数据的模式工作；同样，从服务器专注于读操作，可以用更适合读取数据的模式工作。</li>
<li>强化数据安全，避免单点故障：由于数据同步机制的存在，各个服务器之间数据保持一致，所以其中某个服务器宕机不会导致数据丢失或无法访问。从这个角度说参与主从复制的Redis服务器构成了一个<b><font color="blue">集群</font></b>。</li>
</ul>
<h2 id="2-搭建步骤"><a href="#2-搭建步骤" class="headerlink" title="2.搭建步骤"></a>2.搭建步骤</h2><h3 id="①思路"><a href="#①思路" class="headerlink" title="①思路"></a>①思路</h3><p>Redis集群在运行时使用的是同一个可执行文件，只是对应的配置文件不同。</p>
<p><img src="https://zsy0216.github.io/image/%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84/redis/p03.png" alt="p03"></p>
<p>每个配置文件中相同的参数是：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">daemonize yes</span><br><span class="line">dir /usr/local/cluster-redis</span><br></pre></td></tr></table></figure>

<p>不同的参数有：</p>
<table>
<thead>
<tr>
<th>配置项名称</th>
<th>作用</th>
<th>取值</th>
</tr>
</thead>
<tbody><tr>
<td>port</td>
<td>Redis服务器启动后监听的端口号</td>
<td>6000<br>7000<br>8000</td>
</tr>
<tr>
<td>dbfilename</td>
<td>RDB文件存储位置</td>
<td>dump6000.rdb<br>dump7000.rdb<br>dump8000.rdb</td>
</tr>
<tr>
<td>logfile</td>
<td>日志文件位置</td>
<td>/usr/local/cluster-redis/logs/redis6000.log<br>/usr/local/cluster-redis/logs/redis7000.log<br>/usr/local/cluster-redis/logs/redis8000.log</td>
</tr>
<tr>
<td>pidfile</td>
<td>pid文件位置</td>
<td>/var/run/redis6000.pid<br>/var/run/redis7000.pid<br>/var/run/redis8000.pid</td>
</tr>
</tbody></table>
<h3 id="②步骤"><a href="#②步骤" class="headerlink" title="②步骤"></a>②步骤</h3><ul>
<li>第一步：创建/usr/local/cluster-redis目录</li>
<li>第二步：把原始未经修改的redis.conf复制到/usr/local/cluster-redis目录</li>
<li>第三步：把/usr/local/cluster-redis目录下的redis.conf复制为redis6000.conf</li>
<li>第四步：按照既定计划修改redis6000.conf中的相关配置项<ul>
<li>daemonize yes</li>
<li>dir</li>
<li>port</li>
<li>dbfilename</li>
<li>logfile</li>
<li>pidfile</li>
</ul>
</li>
<li>第五步：复制redis6000.conf为redis7000.conf</li>
<li>第六步：修改redis7000.conf中的相关配置项<ul>
<li>port</li>
<li>dbfilename</li>
<li>logfile</li>
<li>pidfile</li>
</ul>
</li>
<li>第七步：复制redis6000.conf为redis8000.conf</li>
<li>第八步：修改redis8000.conf中的相关配置项<ul>
<li>port</li>
<li>dbfilename</li>
<li>logfile</li>
<li>pidfile</li>
</ul>
</li>
</ul>
<h3 id="③启动Redis主从复制集群"><a href="#③启动Redis主从复制集群" class="headerlink" title="③启动Redis主从复制集群"></a>③启动Redis主从复制集群</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/redis/bin/redis-server /usr/local/cluster-redis/redis6000.conf</span><br><span class="line">/usr/local/redis/bin/redis-server /usr/local/cluster-redis/redis7000.conf</span><br><span class="line">/usr/local/redis/bin/redis-server /usr/local/cluster-redis/redis8000.conf</span><br></pre></td></tr></table></figure>

<p>使用redis-cli停止指定服务器的命令格式如下：<br><code>/usr/local/bin/redis-cli -h IP地址 -p 端口号 shutdown</code></p>
<h2 id="3-主从关系"><a href="#3-主从关系" class="headerlink" title="3.主从关系"></a>3.主从关系</h2><h3 id="①查看主从关系"><a href="#①查看主从关系" class="headerlink" title="①查看主从关系"></a>①查看主从关系</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6000&gt; info replication</span><br><span class="line"><span class="meta">#</span><span class="bash"> Replication</span></span><br><span class="line">role:master</span><br><span class="line">connected_slaves:0</span><br></pre></td></tr></table></figure>

<p>刚刚启动的集群服务器中每一个节点服务器都认为自己是主服务器。需要建立主从关系。</p>
<h3 id="②设定主从关系"><a href="#②设定主从关系" class="headerlink" title="②设定主从关系"></a>②设定主从关系</h3><p>在从机上指定主机位置即可</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SLAVEOF 127.0.0.1 6000</span><br></pre></td></tr></table></figure>

<h3 id="③取消主从关系"><a href="#③取消主从关系" class="headerlink" title="③取消主从关系"></a>③取消主从关系</h3><p>在从机上执行命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SLAVEOF NO ONE</span><br></pre></td></tr></table></figure>

<h2 id="4-初步测试"><a href="#4-初步测试" class="headerlink" title="4.初步测试"></a>4.初步测试</h2><ul>
<li><p>测试1：在主机写入数据，在从机查看</p>
</li>
<li><p>测试2：在从机写入数据报错。配置文件中的依据是：slave-read-only yes</p>
</li>
<li><p>测试3：主机执行SHUTDOWN看从机状态</p>
<p>从机依旧是slave状态，显示主机下线，可以查询数据</p>
</li>
<li><p>测试4：主机恢复启动，看从机状态</p>
<p>显示主机上线，可以查询数据</p>
</li>
<li><p>测试5：从机SHUTDOWN，此时主机写入数据，从机恢复启动查看状态。重新设定主从关系后看新写入的数据是否同步。</p>
<p>从机重新启动又变成master状态，需要重新建立主从关系才可以同步主机新写的数据。</p>
</li>
</ul>
<h2 id="5-哨兵模式"><a href="#5-哨兵模式" class="headerlink" title="5.哨兵模式"></a>5.哨兵模式</h2><h3 id="①作用"><a href="#①作用" class="headerlink" title="①作用"></a>①作用</h3><p>通过哨兵服务器监控master/slave实现主从复制集群的自动管理。</p>
<p><img src="https://zsy0216.github.io/image/%E5%88%86%E5%B8%83%E5%BC%8F%E6%9E%B6%E6%9E%84/redis/p04.png" alt="p04"></p>
<h3 id="②相关概念"><a href="#②相关概念" class="headerlink" title="②相关概念"></a>②相关概念</h3><h4 id="1-主观下线"><a href="#1-主观下线" class="headerlink" title="[1]主观下线"></a>[1]主观下线</h4><p>1台哨兵检测到某节点服务器下线。</p>
<h4 id="2-客观下线"><a href="#2-客观下线" class="headerlink" title="[2]客观下线"></a>[2]客观下线</h4><p>认为某个节点服务器下线的哨兵服务器达到指定数量。这个数量后面在哨兵的启动配置文件中指定。</p>
<h3 id="③配置方式"><a href="#③配置方式" class="headerlink" title="③配置方式"></a>③配置方式</h3><p>简单起见我们只配置一台哨兵。我们所需要做的就是创建一个哨兵服务器运行所需要的配置文件。</p>
<p>新建并编辑sentinel的配置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/cluster-redis/sentinel.conf</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">配置文件加入：</span></span><br><span class="line">sentinel monitor mymaster 127.0.0.1 6000 1</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>格式</th>
<th>sentinel monitor 为主机命名 主机IP 主机端口号 将主机判定为下线时需要Sentinel同意的数量</th>
</tr>
</thead>
<tbody><tr>
<td>例子</td>
<td>sentinel monitor mymaster 127.0.0.1 6000 1</td>
</tr>
</tbody></table>
<h3 id="④启动哨兵"><a href="#④启动哨兵" class="headerlink" title="④启动哨兵"></a>④启动哨兵</h3><p>根据新建的sentinel的配置文件启动redis</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/redis/bin/redis-server /usr/local/cluster-redis/sentinel.conf --sentinel</span><br></pre></td></tr></table></figure>

<p>下面是哨兵模式的日志打印情况</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 启动哨兵模式，根据配置指定主服务器，并自动建立主从关系</span></span><br><span class="line">+monitor master mymaster 127.0.0.1 6000 quorum 1</span><br><span class="line">8516:X 17 Oct 20:45:45.960 * </span><br><span class="line">+slave slave 127.0.0.1:8000 127.0.0.1 8000 @ mymaster 127.0.0.1 6000</span><br><span class="line">8516:X 17 Oct 20:45:45.961 * </span><br><span class="line">+slave slave 127.0.0.1:7000 127.0.0.1 7000 @ mymaster 127.0.0.1 6000</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> shutdown7000从服务器 从服务器[主观下线]</span></span><br><span class="line">+sdown slave 127.0.0.1:7000 127.0.0.1 7000 @ mymaster 127.0.0.1 6000</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 7000从服务器重新启动</span></span><br><span class="line">+reboot slave 127.0.0.1:7000 127.0.0.1 7000 @ mymaster 127.0.0.1 6000</span><br><span class="line">-sdown slave 127.0.0.1:7000 127.0.0.1 7000 @ mymaster 127.0.0.1 6000</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 从服务器会重新设置主从关系到主服务器</span></span></span><br><span class="line">+convert-to-slave slave 127.0.0.1:7000 127.0.0.1 7000 @ mymaster 127.0.0.1 6000</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> shotdown6000主服务器------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 主服务器[主观下线]</span></span></span><br><span class="line">+sdown master mymaster 127.0.0.1 6000</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 主服务器[客观下线]</span></span></span><br><span class="line">+odown master mymaster 127.0.0.1 6000 #quorum 1/1</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 选举leader</span></span></span><br><span class="line">+vote-for-leader 55717050322c1b4fc6888971e37d3dc2b6131cd4 1</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 把其中一个从服务器设置为主服务器，并将其他作为从服务器</span></span></span><br><span class="line">+failover-state-send-slaveof-noone slave 127.0.0.1:8000 127.0.0.1 8000 @ mymaster 127.0.0.1 6000</span><br><span class="line">+switch-master mymaster 127.0.0.1 6000 127.0.0.1 8000</span><br><span class="line">+slave slave 127.0.0.1:7000 127.0.0.1 7000 @ mymaster 127.0.0.1 8000</span><br><span class="line">+slave slave 127.0.0.1:6000 127.0.0.1 6000 @ mymaster 127.0.0.1 8000</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 重新启动原来的主服务器6000 </span></span><br><span class="line">-sdown slave 127.0.0.1:6000 127.0.0.1 6000 @ mymaster 127.0.0.1 8000</span><br><span class="line">+convert-to-slave slave 127.0.0.1:6000 127.0.0.1 6000 @ mymaster 127.0.0.1 8000</span><br></pre></td></tr></table></figure>

<h1 id="九、发布订阅"><a href="#九、发布订阅" class="headerlink" title="九、发布订阅"></a>九、发布订阅</h1><h2 id="1-订阅一个频道"><a href="#1-订阅一个频道" class="headerlink" title="1.订阅一个频道"></a>1.订阅一个频道</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; SUBSCRIBE cctv1</span><br><span class="line">Reading messages... (press Ctrl-C to quit)</span><br><span class="line">1) "subscribe"</span><br><span class="line">2) "cctv1"</span><br><span class="line">3) (integer) 1</span><br></pre></td></tr></table></figure>

<h2 id="2-在一个频道上发布信息"><a href="#2-在一个频道上发布信息" class="headerlink" title="2.在一个频道上发布信息"></a>2.在一个频道上发布信息</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; PUBLISH cctv1 weather</span><br><span class="line">(integer) 1</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; SUBSCRIBE cctv1</span><br><span class="line">Reading messages... (press Ctrl-C to quit)</span><br><span class="line">1) "subscribe"</span><br><span class="line">2) "cctv1"</span><br><span class="line">3) (integer) 1</span><br><span class="line">1) "message"</span><br><span class="line">2) "cctv1"</span><br><span class="line">3) "weather"</span><br></pre></td></tr></table></figure>

<h1 id="十、Jedis"><a href="#十、Jedis" class="headerlink" title="十、Jedis"></a>十、Jedis</h1><p>代码示例：<a href="https://github.com/zsy0216/JedisDemo" target="_blank" rel="noopener">Github-JedisDemo</a></p>
<h2 id="1-一个对比"><a href="#1-一个对比" class="headerlink" title="1.一个对比"></a>1.一个对比</h2><table>
<thead>
<tr>
<th></th>
<th>MySQL</th>
<th>Redis</th>
</tr>
</thead>
<tbody><tr>
<td>连接</td>
<td>Connection</td>
<td>Jedis</td>
</tr>
<tr>
<td>连接池</td>
<td>C3P0等等</td>
<td>JedisPool</td>
</tr>
<tr>
<td>操作完成</td>
<td>关闭连接</td>
<td>关闭连接</td>
</tr>
</tbody></table>
<h2 id="2-Redis准备"><a href="#2-Redis准备" class="headerlink" title="2.Redis准备"></a>2.Redis准备</h2><h3 id="①理解Redis配置文件中bind配置项含义"><a href="#①理解Redis配置文件中bind配置项含义" class="headerlink" title="①理解Redis配置文件中bind配置项含义"></a>①理解Redis配置文件中bind配置项含义</h3><p>bind后面跟的ip地址是客户端访问Redis时使用的IP地址。看下面例子：<br>| bind值          | 访问方式                       |<br>| ————— | —————————— |<br>| 127.0.0.1       | ./redis-cli -h 127.0.0.1       |<br>| 192.168.200.100 | ./redis-cli -h 192.168.200.100 |</p>
<h3 id="②查看Linux系统本机IP"><a href="#②查看Linux系统本机IP" class="headerlink" title="②查看Linux系统本机IP"></a>②查看Linux系统本机IP</h3><p>远程客户端访问Linux服务器时不能使用127.0.0.1，要使用网络上的实际IP。可以用ifconfig命令查看。</p>
<h3 id="③将Redis配置文件中的bind配置项设置为本机IP。"><a href="#③将Redis配置文件中的bind配置项设置为本机IP。" class="headerlink" title="③将Redis配置文件中的bind配置项设置为本机IP。"></a>③将Redis配置文件中的bind配置项设置为本机IP。</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bind [你的实际IP]</span><br><span class="line">bind 192.168.252.128</span><br></pre></td></tr></table></figure>

<h2 id="3-Jedis"><a href="#3-Jedis" class="headerlink" title="3.Jedis"></a>3.Jedis</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>redis.clients<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jedis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//指定Redis服务器的IP地址和端口号</span></span><br><span class="line">Jedis jedis = <span class="keyword">new</span> Jedis(<span class="string">"192.168.252.128"</span>, <span class="number">6379</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//执行ping命令</span></span><br><span class="line">String ping = jedis.ping();</span><br><span class="line">System.out.println(ping);   <span class="comment">// PONG</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//关闭连接</span></span><br><span class="line">jedis.close();</span><br></pre></td></tr></table></figure>

<h2 id="4-JedisPool"><a href="#4-JedisPool" class="headerlink" title="4.JedisPool"></a>4.JedisPool</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//声明Linux服务器IP地址</span></span><br><span class="line">String host = <span class="string">"192.168.252.128"</span>;</span><br><span class="line"><span class="comment">//声明Redis端口号</span></span><br><span class="line"><span class="keyword">int</span> port = Protocol.DEFAULT_PORT;</span><br><span class="line"></span><br><span class="line"><span class="comment">//创建连接池对象</span></span><br><span class="line">JedisPool jedisPool = <span class="keyword">new</span> JedisPool(host, port);</span><br><span class="line"><span class="comment">//获取Jedis对象连接Redis</span></span><br><span class="line">Jedis jedis = jedisPool.getResource();</span><br><span class="line"></span><br><span class="line"><span class="comment">//执行具体操作</span></span><br><span class="line">String ping = jedis.ping();</span><br><span class="line">System.out.println(ping);  <span class="comment">// PONG</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//关闭连接</span></span><br><span class="line">jedisPool.close();</span><br></pre></td></tr></table></figure>

<p>代码示例：<a href="https://github.com/zsy0216/JedisDemo" target="_blank" rel="noopener">Github-JedisDemo</a></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/redis/" rel="tag"># redis</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/10/18/Zookeeper学习记录/" rel="next" title="Zookeeper学习记录">
                <i class="fa fa-chevron-left"></i> Zookeeper学习记录
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/10/21/Java基础面试题/" rel="prev" title="Java基础面试题">
                Java基础面试题 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
    </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
      <div id="sidebar-dimmer"></div>
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/head.jpg" alt="Tassel">
            
              <p class="site-author-name" itemprop="name">Tassel</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">28</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">22</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/zsy0216" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="http://weibo.com/5480278181" target="_blank" title="微博">
                      
                        <i class="fa fa-fw fa-weibo"></i>微博</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://blog.csdn.net/Ep_Little_prince" target="_blank" title="CSDN">
                      
                        <i class="fa fa-fw fa-crosshairs"></i>CSDN</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#二、Redis简介"><span class="nav-number">1.</span> <span class="nav-text">二、Redis简介</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#三、Redis安装"><span class="nav-number">2.</span> <span class="nav-text">三、Redis安装</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-下载并解压安装"><span class="nav-number">2.1.</span> <span class="nav-text">1. 下载并解压安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-安装C语言编译环境"><span class="nav-number">2.2.</span> <span class="nav-text">2. 安装C语言编译环境</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-修改安装位置"><span class="nav-number">2.3.</span> <span class="nav-text">3. 修改安装位置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-编译安装"><span class="nav-number">2.4.</span> <span class="nav-text">4. 编译安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-启动Redis服务器"><span class="nav-number">2.5.</span> <span class="nav-text">5.启动Redis服务器</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#①默认启动"><span class="nav-number">2.5.1.</span> <span class="nav-text">①默认启动</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#②定制配置项启动"><span class="nav-number">2.5.2.</span> <span class="nav-text">②定制配置项启动</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-准备配置文件"><span class="nav-number">2.5.2.1.</span> <span class="nav-text">[1]准备配置文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-修改配置项"><span class="nav-number">2.5.2.2.</span> <span class="nav-text">[2]修改配置项</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-让Redis根据指定的配置文件启动"><span class="nav-number">2.5.2.3.</span> <span class="nav-text">[3]让Redis根据指定的配置文件启动</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-客户端登录"><span class="nav-number">2.6.</span> <span class="nav-text">6.客户端登录</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#四、Redis五种常用数据结构"><span class="nav-number">3.</span> <span class="nav-text">四、Redis五种常用数据结构</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-总体结构"><span class="nav-number">3.1.</span> <span class="nav-text">1.总体结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-string类型"><span class="nav-number">3.2.</span> <span class="nav-text">2.string类型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-list类型"><span class="nav-number">3.3.</span> <span class="nav-text">3.list类型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-set类型"><span class="nav-number">3.4.</span> <span class="nav-text">2.set类型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-hash类型"><span class="nav-number">3.5.</span> <span class="nav-text">3.hash类型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-zset类型"><span class="nav-number">3.6.</span> <span class="nav-text">4.zset类型</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#五、Redis命令行操作"><span class="nav-number">4.</span> <span class="nav-text">五、Redis命令行操作</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-基本操作"><span class="nav-number">4.1.</span> <span class="nav-text">1.基本操作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#①切换数据库"><span class="nav-number">4.1.1.</span> <span class="nav-text">①切换数据库</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#②查看数据库长度"><span class="nav-number">4.1.2.</span> <span class="nav-text">②查看数据库长度</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-KEY操作"><span class="nav-number">4.2.</span> <span class="nav-text">2.KEY操作</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-string操作"><span class="nav-number">4.3.</span> <span class="nav-text">2.string操作</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-list操作"><span class="nav-number">4.4.</span> <span class="nav-text">3.list操作</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-set操作"><span class="nav-number">4.5.</span> <span class="nav-text">4.set操作</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-hash操作"><span class="nav-number">4.6.</span> <span class="nav-text">5.hash操作</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-zset操作"><span class="nav-number">4.7.</span> <span class="nav-text">6.zset操作</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#六、Redis持久化机制"><span class="nav-number">5.</span> <span class="nav-text">六、Redis持久化机制</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-RDB"><span class="nav-number">5.1.</span> <span class="nav-text">1.RDB</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#①机制描述"><span class="nav-number">5.1.1.</span> <span class="nav-text">①机制描述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#②触发时机"><span class="nav-number">5.1.2.</span> <span class="nav-text">②触发时机</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-基于默认配置"><span class="nav-number">5.1.2.1.</span> <span class="nav-text">[1]基于默认配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-使用保存命令"><span class="nav-number">5.1.2.2.</span> <span class="nav-text">[2]使用保存命令</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-使用flushall命令"><span class="nav-number">5.1.2.3.</span> <span class="nav-text">[3]使用flushall命令</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-服务器关闭"><span class="nav-number">5.1.2.4.</span> <span class="nav-text">[4]服务器关闭</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#③相关配置"><span class="nav-number">5.1.3.</span> <span class="nav-text">③相关配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#④思考"><span class="nav-number">5.1.4.</span> <span class="nav-text">④思考</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-AOF"><span class="nav-number">5.2.</span> <span class="nav-text">2.AOF</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#①机制描述-1"><span class="nav-number">5.2.1.</span> <span class="nav-text">①机制描述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#②AOF基本配置"><span class="nav-number">5.2.2.</span> <span class="nav-text">②AOF基本配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#③AOF重写"><span class="nav-number">5.2.3.</span> <span class="nav-text">③AOF重写</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-持久化文件损坏修复"><span class="nav-number">5.3.</span> <span class="nav-text">3.持久化文件损坏修复</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-扩展阅读：两种持久化机制的取舍"><span class="nav-number">5.4.</span> <span class="nav-text">4.扩展阅读：两种持久化机制的取舍</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#①RDB"><span class="nav-number">5.4.1.</span> <span class="nav-text">①RDB</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-优势"><span class="nav-number">5.4.1.1.</span> <span class="nav-text">[1]优势</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-劣势"><span class="nav-number">5.4.1.2.</span> <span class="nav-text">[2]劣势</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#②AOF"><span class="nav-number">5.4.2.</span> <span class="nav-text">②AOF</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-优势-1"><span class="nav-number">5.4.2.1.</span> <span class="nav-text">[1]优势</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-劣势-1"><span class="nav-number">5.4.2.2.</span> <span class="nav-text">[2]劣势</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#③RDB和AOF并存"><span class="nav-number">5.4.3.</span> <span class="nav-text">③RDB和AOF并存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#④使用建议"><span class="nav-number">5.4.4.</span> <span class="nav-text">④使用建议</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#七、Redis事务控制"><span class="nav-number">6.</span> <span class="nav-text">七、Redis事务控制</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-Redis事务控制的相关命令"><span class="nav-number">6.1.</span> <span class="nav-text">1.Redis事务控制的相关命令</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-命令队列执行失败的两种情况"><span class="nav-number">6.2.</span> <span class="nav-text">2.命令队列执行失败的两种情况</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#①加入队列时失败"><span class="nav-number">6.2.1.</span> <span class="nav-text">①加入队列时失败</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#②执行队列时失败"><span class="nav-number">6.2.2.</span> <span class="nav-text">②执行队列时失败</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#③Redis为什么不支持回滚"><span class="nav-number">6.2.3.</span> <span class="nav-text">③Redis为什么不支持回滚</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-悲观锁和乐观锁"><span class="nav-number">6.3.</span> <span class="nav-text">3.悲观锁和乐观锁</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#八、Redis主从复制机制"><span class="nav-number">7.</span> <span class="nav-text">八、Redis主从复制机制</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-读写分离的好处："><span class="nav-number">7.1.</span> <span class="nav-text">1.读写分离的好处：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-搭建步骤"><span class="nav-number">7.2.</span> <span class="nav-text">2.搭建步骤</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#①思路"><span class="nav-number">7.2.1.</span> <span class="nav-text">①思路</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#②步骤"><span class="nav-number">7.2.2.</span> <span class="nav-text">②步骤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#③启动Redis主从复制集群"><span class="nav-number">7.2.3.</span> <span class="nav-text">③启动Redis主从复制集群</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-主从关系"><span class="nav-number">7.3.</span> <span class="nav-text">3.主从关系</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#①查看主从关系"><span class="nav-number">7.3.1.</span> <span class="nav-text">①查看主从关系</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#②设定主从关系"><span class="nav-number">7.3.2.</span> <span class="nav-text">②设定主从关系</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#③取消主从关系"><span class="nav-number">7.3.3.</span> <span class="nav-text">③取消主从关系</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-初步测试"><span class="nav-number">7.4.</span> <span class="nav-text">4.初步测试</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-哨兵模式"><span class="nav-number">7.5.</span> <span class="nav-text">5.哨兵模式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#①作用"><span class="nav-number">7.5.1.</span> <span class="nav-text">①作用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#②相关概念"><span class="nav-number">7.5.2.</span> <span class="nav-text">②相关概念</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-主观下线"><span class="nav-number">7.5.2.1.</span> <span class="nav-text">[1]主观下线</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-客观下线"><span class="nav-number">7.5.2.2.</span> <span class="nav-text">[2]客观下线</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#③配置方式"><span class="nav-number">7.5.3.</span> <span class="nav-text">③配置方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#④启动哨兵"><span class="nav-number">7.5.4.</span> <span class="nav-text">④启动哨兵</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#九、发布订阅"><span class="nav-number">8.</span> <span class="nav-text">九、发布订阅</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-订阅一个频道"><span class="nav-number">8.1.</span> <span class="nav-text">1.订阅一个频道</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-在一个频道上发布信息"><span class="nav-number">8.2.</span> <span class="nav-text">2.在一个频道上发布信息</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#十、Jedis"><span class="nav-number">9.</span> <span class="nav-text">十、Jedis</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-一个对比"><span class="nav-number">9.1.</span> <span class="nav-text">1.一个对比</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-Redis准备"><span class="nav-number">9.2.</span> <span class="nav-text">2.Redis准备</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#①理解Redis配置文件中bind配置项含义"><span class="nav-number">9.2.1.</span> <span class="nav-text">①理解Redis配置文件中bind配置项含义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#②查看Linux系统本机IP"><span class="nav-number">9.2.2.</span> <span class="nav-text">②查看Linux系统本机IP</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#③将Redis配置文件中的bind配置项设置为本机IP。"><span class="nav-number">9.2.3.</span> <span class="nav-text">③将Redis配置文件中的bind配置项设置为本机IP。</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-Jedis"><span class="nav-number">9.3.</span> <span class="nav-text">3.Jedis</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-JedisPool"><span class="nav-number">9.4.</span> <span class="nav-text">4.JedisPool</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="powered-by">
<i class="fa fa-user-md"></i><span id="busuanzi_container_site_uv">
  本站访客数:<span id="busuanzi_value_site_pv"></span>
</span>
</div>

<div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Tassel</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">106.6k</span>
  
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>


  
    <style>
    .copy-btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      line-height: 20px;
      color: #333;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      background-color: #eee;
      background-image: linear-gradient(#fcfcfc, #eee);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      user-select: none;
      outline: 0;
    }

    .highlight-wrap .copy-btn {
      transition: opacity .3s ease-in-out;
      opacity: 0;
      padding: 2px 6px;
      position: absolute;
      right: 4px;
      top: 8px;
    }

    .highlight-wrap:hover .copy-btn,
    .highlight-wrap .copy-btn:focus {
      opacity: 1
    }

    .highlight-wrap {
      position: relative;
    }
  </style>

  <script>
    $('.highlight').each(function (i, e) {
      var $wrap = $('<div>').addClass('highlight-wrap')
      $(e).after($wrap)
      $wrap.append($('<button>').addClass('copy-btn').append('复制').on('click', function (e) {
        var code = $(this).parent().find('.code').find('.line').map(function (i, e) {
          return $(e).text()
        }).toArray().join('\n')
        var ta = document.createElement('textarea')
        document.body.appendChild(ta)
        ta.style.position = 'absolute'
        ta.style.top = '0px'
        ta.style.left = '0px'
        ta.value = code
        ta.select()
        ta.focus()
        var result = document.execCommand('copy')
        document.body.removeChild(ta)

        if(result)$(this).text('复制成功')
        else $(this).text('复制失败')

        $(this).blur()
      })).on('mouseleave', function (e) {
        var $b = $(this).find('.copy-btn')
        setTimeout(function () {
          $b.text('复制')
        }, 300)
      }).append(e)
    })
  </script>


  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: '1Knze8g28GXxJLpYTiFG0slr-gzGzoHsz',
        appKey: '22bESOBllAT3KlpN2a55bvWN',
        placeholder: 'Just go go',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "./public/search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("9VVhv0RPXqLP7GHimPD7BQ6Y-gzGzoHsz", "GI6gXQhWWFJIYCIXAYM627ut");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  
  

  

  

  

  
  
  
</body>
</html>

<!-- 页面点击小红心和文字 -->
<script type="text/javascript" src="/js/src/click_show_love.js"></script>
<!-- <script type="text/javascript" src="/js/src/click_show_text.js"></script> -->